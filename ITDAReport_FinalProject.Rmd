---
title: "Restaurant Final Project IT"
author: "Will Rains, Samousa Fofana, Alec Dudognon"
date: "11/21/2021"
output: 
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F,warning = F)
```

# Introduction

## Problem Statement

## Dataset




# Analysis

## Step 1 - read in the dataset

```{r}
reservations <- read.csv("reservation_data.csv")
visits <- read.csv("visit_data.csv")
date_info <- read.csv("date_info.csv")
restaurant_info <- read.csv("restaurant_info.csv")

```

All the relevant data is read in - we started from a point where we ran SQL queries to get the restaurant information into the reservations and visits tables but need to do some variable manipulation to align the dates to get the date information to a point where we can join as some datasets store the date in different ways. For this we will use the **lubridate** package in R.

## Load relevant packages for analysis

```{r}
library(tidyverse)
library(lubridate)
```

## Examine the variables in the datasets

```{r}
for(data in list(reservations,visits,date_info,restaurant_info)) {
  
  print(skimr::skim(data))
}

```


## Convert the date variables with lubridate

```{r}
reservations$visit_datetime <- ymd_hms(reservations$visit_datetime)
reservations$reserve_datetime <- ymd_hms(reservations$reserve_datetime)

visits$visit_date <- ymd(visits$visit_date)

date_info$calendar_date <- ymd(date_info$calendar_date)


```


## Examine the dates in each dataset
```{r}
tribble(
  ~"variable",                       ~"Reservation",          ~"Visits", ~"Date-Info",
  "visit min", min(reservations$visit_datetime), min(visits$visit_date), NA,
  "visit max", max(reservations$visit_datetime), max(visits$visit_date), NA,
  "reserve min", min(reservations$reserve_datetime), NA, NA,
  "reserve max", max(reservations$reserve_datetime), NA, NA,
  "Other min", NA                                  , NA, min(date_info$calendar_date),
  "Other max", NA                                  , NA, max(date_info$calendar_date)
  
)

```
From this output we can see the date ranges of the datasets.


Now we will summarize by day.

```{r}
reserve_data_day_summed <- reservations %>% mutate(reserveDay = day(reserve_datetime))

tail(reserve_data_day_summed)

reservations<- reservations%>%mutate(day_reservation = day(reservations$reserve_datetime))
reservations<- reservations%>%mutate(month_reservation = month(reservations$reserve_datetime))
reservations<- reservations%>%mutate(year_reservation = 2017)
reservations<- reservations%>%mutate(date = '')

reservations$date <- as.Date(with(reservations, paste(year_reservation, month_reservation, day_reservation,sep="-")), "%Y-%m-%d")

reservation_per_day <- reservations %>%
  mutate(day_mon_rest=paste(day_reservation,month_reservation,ID))%>%
  group_by(ID,day_mon_rest,date) %>%
  summarise(Tot_visit_day_from_Reservations = sum(reserve_visitors),
            count_of_reservations = n()) 

head(reservation_per_day)
```
Now we've created a summarized version of the reservation dataset and we need to join this into the visits dataset to form our total dataset with all of the variables we will use

```{r}
visits <- visits %>% add_row(ID="restaurant_ 292",air_genre_name="Cafe/Sweets",air_area_name="T?ky?-to Shibuya-ku Shibuya",latitude=35.66178,longitude=139.7041) %>% add_row(ID="restaurant_ 325",air_genre_name="Cafe/Sweets",air_area_name="Hokkaid? Sapporo-shi Minami 3 J?nishi",latitude=43.05546,longitude=141.341)

combinedDataset <- visits %>% mutate(date = visit_date) %>%  left_join(reservation_per_day,by = c('date','ID')) %>%
  mutate(calendar_date=date) %>% left_join(date_info,by='calendar_date')

combinedDataset %>% group_by(air_genre_name) %>% summarise(avgDailyVisitsGenre = mean(visitors))

combinedDataset <- combinedDataset %>% left_join(
  y=(combinedDataset %>% group_by(air_genre_name) %>% summarise(avgDailyVisitsGenre = mean(visitors))),
by="air_genre_name")



skimr::skim(combinedDataset)
```

Create Training and test
```{r}
trainset <- subset(combinedDataset,visit_date <= as.Date("2017-03-10"))
testset <- subset(combinedDataset,visit_date > as.Date("2017-03-10"))
```



## Now we wwill begin to fit with linear regression models to start
This is a simpler modeling technique and we want to start here to see if by chance it is the best fitting type of model. 

### Model 1
```{r}

skimr::skim(combinedDataset)

names(combinedDataset)

mod1<-lm(visitors ~ date + air_genre_name+latitude+longitude+count_of_reservations, data=trainset)

summary(mod1)
```



### Model 2

```{r}


mod2<- lm( visitors ~ date + Tot_visit_day_from_Reservations + day_of_week + holiday_flg + air_genre_name + latitude + longitude, data=trainset)

summary(mod2)
```

### Model 3
```{r}
mod3<- lm( visitors ~ visit_date + Tot_visit_day_from_Reservations + day_of_week + holiday_flg + air_genre_name + air_area_name, data=trainset)
summary(mod3)
```

### Model 4

```{r}
mod4<- lm( visitors ~  ID + visit_date + Tot_visit_day_from_Reservations + day_of_week + holiday_flg + air_genre_name + latitude + longitude, data=trainset)
summary(mod4)

```

### Model 5 

```{r}
mod5<- lm( visitors ~  ID + day_of_week + holiday_flg + air_genre_name + air_area_name, data=trainset)
summary(mod5)

```

### Model 6

```{r}
mod6<- lm( visitors ~  visit_date + day_of_week + holiday_flg + air_genre_name + air_area_name, data=trainset)
summary(mod6)
```



# validation of the model

```{r}
predictTest<-predict(mod5, newdata = (testset%>%filter(ID!="restaurant_ 514"&ID!="restaurant_ 516"&ID!="restaurant_ 573")%>%arrange(ID)))

#Calculation of SSE

testset=testset %>%arrange(ID)

testset$visitors%>%length()

predictTest%>%length()


sse<-sum((testset$visitors-predictTest)^2)

#Calculation of the average of Tot visi per day in the Test set

ybar<- mean(testset$visitors)

#Calculation of SST

sst<-sum((testset$visitors-ybar)^2)

#Calculation of R-squared

rsquared<- (1-(sse/sst))

rsquared

############### Method from below may work here but something needs to be fixed with the datasets

names(testset)
testset<-testset%>%filter(ID!="restaurant_ 514",ID!="restaurant_ 516",ID!="restaurant_ 573")
predictTest1<-predict(mod5, newdata = testset)

#Calculation of SSE

sse<-sum((testset$visitors-predictTest1)^2)

#Calculation of the average of Tot visi per day in the Test set

ybar2<- mean(testset$visitors)

#Calculation of SST

sst<-sum((testset$visitors-ybar2)^2)

#Calculation of R-squared

rsquared2<- (1-(sse/sst))

rsquared2



```

##################NEEED TO FIX - TEST SET AND PREDICTION NOT THE SAME IN THIS CASE

## Refitting LM model with full dataset

Now that we've tested with a train test split we want to reload the best LM model with the full dataset so that we don't drop levels when we predict the submission dataset.

```{r}
mod5<- lm( visitors ~  ID + day_of_week + holiday_flg + air_genre_name + air_area_name, data=combinedDataset)
summary(mod5)
```


```{r}
submission <- read.csv("project_submission (3).csv")
```

```{r}
submission<-submission%>%mutate(date1 = str_sub(ID,-10,-1))
submission<-submission%>%mutate(id = str_sub(ID,1,-13))
submission$date1<-ymd(submission$date1)
head(submission)
submission[1,4]
submission$id <- str_trim(submission$id)
submission[1,4]

print('submission')
names(submission)
print('combined')
names(combinedDataset)
submission<-rename(submission,id=ID,date=date1,ID=id)
head(submission)
head(combinedDataset)
submission$counter <- seq(from=1,to=15770,by=1) 

skimr::skim(submission)

submission <- submission %>% left_join(restaurant_info %>% select(-X),by="ID") %>% left_join(date_info %>% mutate(date = calendar_date),by="date")

submission %>% pull(ID) %>% unique() %>%length() 
restaurant_info %>% pull(ID) %>% unique() %>%length() 

combinedDataset %>% filter(ID == "restaurant_ 292")

visits %>% filter(ID == "restaurant_ 292")

restaurant_info %>% filter(ID == "restaurant_ 292")

submission_zeroes <- submission %>% filter(ID=="restaurant_ 292"|ID=="restaurant_ 325")

submission <- submission %>% filter(ID!="restaurant_ 292"&ID!="restaurant_ 325")


submission$visitors <- predict(mod5, newdata = submission)
submission$visitors <- round(submission$visitors,0)
submission_zeroes <- submission_zeroes %>% select(id,visitors,counter)
submission <- submission %>% select(id,visitors,counter)
submission <-rename(submission,ID=id)
names(submission_zeroes)
submission_zeroes <-rename(submission_zeroes,ID=id)
# submission <- submission %>% add_row(ID="restaurant_ 292",visitors=0) %>% add_row(ID="restaurant_ 325",visitors=0)

glimpse(submission)

submission <- bind_rows(submission,submission_zeroes) %>%arrange(counter)%>%select(-counter)

skimr::skim(submission)

submission %>% filter(str_detect(ID,"restaurant_ 292")|str_detect(ID,"restaurant_ 325"))

submission %>% janitor::tabyl(visitors)

submission$visitors <- if_else(submission$visitors<0,0,submission$visitors)

submission %>% janitor::tabyl(visitors)

submission %>% write_csv("project6_data_submission.csv")

```

factor ID has new levels restaurant_ 292, restaurant_ 325

submission <- submission %>% left_join(combinedDataset %>% select(-visit_date,-visitors,-date,-day_mon_rest,-Tot_visit_day_from_Reservations,-count_of_reservations,-X.x,-X.y,-calendar_date,-ID.1),by="ID")

mod5<- lm( visitors ~  ID + day_of_week + holiday_flg + air_genre_name + air_area_name, data=combinedDataset)
summary(mod5)


######################Breaks rules of testing with the testset included in the model - need to move before we use the combined dataset##########################
```{r}

```
######################Breaks rules of testing with the testset included in the model - need to move before we use the combined dataset##########################


## Now let's explore decision tree fits

Now we specify and then fit the models.


```{r}
library(tidymodels)

set.seed(42)

data_split <- initial_time_split(combinedDataset, prop = 0.75)

tm_train <- training(data_split) 
tm_test <- testing(data_split)

tm_rec <- tm_train %>%
  recipe(visitors ~ . ) %>%
  step_normalize(all_predictors())

# Show the result of our recipe
tm_rec 

```
To combine the data preparation with the model building, we use the **workflows**.

```{r}
tree_spec <- decision_tree() %>%
  set_engine("rpart") %>%
  set_mode("regression") %>%
  translate()

tree_fit <- tree_spec %>%
  fit(visitors ~ .,
      data=tm_train)
    
    
tree_wf <- workflow() %>%
  add_recipe(tm_rec) %>%
  add_model(tree_spec)

# lm_folds <-
#  vfold_cv(tm_train)
# 
# tree_res <- fit_resamples(tree_wf, 
#                          lm_folds ,
#                          control=control_resamples(save_pred = TRUE)
# )
# 
# tree_res %>%
#   collect_metrics()                



```







```{r}
#define a workflow to train the model 
 
# tm_wf <- workflow() %>%
#  add_model(fifa_lm) %>% 
#  add_recipe(fifa_rec)

```


