---
title: "Restaurant Final Project IT"
author: "Michael Rains, Samousa Fofana, Alec Dudognon"
date: "11/21/2021"
output: 
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

# Introduction

## Problem Statement

For this project, we need to forecast the number of customers expected for the different restaurants in our data set. We have a certain amount of information about these restaurants like reservations, dates with the number of customers and reservations
etc... So we will make this prediction using different model (i.e. linear, decision tree and raandom forest model)



# Analysis

First of all we start read the database from mysql using the library RMysql

library(RMySQL)


mydb <- dbConnect(
  MySQL(), 
  user="newuser",
  password="will-20",
  dbname="ITDAproject",
  host="127.0.0.1"
)

dbListTables(mydb)

air_reserve <- dbGetQuery(mydb, 
"
SELECT R.*, RI.*
FROM air_reserve R left JOIN restaurant_info RI USING(ID);
")

air_visit <- dbGetQuery(mydb, 
                        "
SELECT V.*, RI.*
FROM air_visit V left JOIN restaurant_info RI USING(ID);
")
date_info <- dbGetQuery(mydb, 
                        "
SELECT * 
FROM date_info;
")
restaurant_info <- dbGetQuery(mydb, 
                              "
SELECT * 
FROM restaurant_info;
")

# It's polite to let the database know when you're done
dbDisconnect(mydb)

library(tidyverse)

glimpse(air_reserve)
glimpse(air_visit)
glimpse(date_info)
glimpse(restaurant_info)

# We will now write the csv files that we will use in the rest of the analysis

write.csv(air_reserve,"reservation_data.csv")
write.csv(air_visit,"visit_data.csv")
write.csv(date_info,"date_info.csv")
write.csv(restaurant_info,"restaurant_info.csv")
#########################################################################
## Step 1 - read in the dataset

```{r}
reservations <- read.csv("reservation_data.csv")
visits <- read.csv("visit_data.csv")
date_info <- read.csv("date_info.csv")
restaurant_info <- read.csv("restaurant_info.csv")

```

All the relevant data is read in - we started from a point where we ran SQL queries to get the restaurant information into the reservations and visits tables but need to do some variable manipulation to align the dates to get the date information to a point where we can join as some datasets store the date in different ways. For this we will use the **lubridate** package in R.


## Dataset

In this part we will become aware of the differents dataset we have at our disposal :

``` {r names res}
names(reservations)
```

First we have a dataset about the reservations in detail, with the
number of expected reservations, the number of visitors with the date
coupled with the restaurant ID.

``` {r names visits}
names(visits)
```

This table concerns the reservation part of our work. Indeed we find
the ID of the restaurants with the corresponding data with the number
of visitors.

``` {r names date_info}
names(date_info)
```

This dataset allows us to have information on the different dates
contained in the reservation dataset. We can know the exact day and
if it is a vacation.

``` {r names rest_info}
names(restaurant_info)

```

This dataset concerns the information specific to the restaurants we
will analyze. We have an identification number (ID) for each
restaurant and information about the type of restaurant and its
location.



## Load relevant packages for analysis

```{r}
library(tidyverse)
library(lubridate)
```

## Examine the variables in the datasets

```{r}
for(data in list(reservations,visits,date_info,restaurant_info)) {
  
  print(skimr::skim(data))
}

```


## Convert the date variables with lubridate

```{r}
reservations$visit_datetime <- ymd_hms(reservations$visit_datetime)
reservations$reserve_datetime <- ymd_hms(reservations$reserve_datetime)

visits$visit_date <- ymd(visits$visit_date)

date_info$calendar_date <- ymd(date_info$calendar_date)


```


## Examine the dates in each dataset
```{r}
tribble(
  ~"variable",                       ~"Reservation",          ~"Visits", ~"Date-Info",
  "visit min", min(reservations$visit_datetime), min(visits$visit_date), NA,
  "visit max", max(reservations$visit_datetime), max(visits$visit_date), NA,
  "reserve min", min(reservations$reserve_datetime), NA, NA,
  "reserve max", max(reservations$reserve_datetime), NA, NA,
  "Other min", NA                                  , NA, min(date_info$calendar_date),
  "Other max", NA                                  , NA, max(date_info$calendar_date)
  
)

```
From this output we can see the date ranges of the datasets.


Now we will summarize by day.

```{r}
reserve_data_day_summed <- reservations %>% mutate(reserveDay = day(reserve_datetime))

tail(reserve_data_day_summed)

reservations<- reservations%>%mutate(day_reservation = day(reservations$reserve_datetime))
reservations<- reservations%>%mutate(month_reservation = month(reservations$reserve_datetime))
reservations<- reservations%>%mutate(year_reservation = 2017)
reservations<- reservations%>%mutate(date = '')

reservations$date <- as.Date(with(reservations, paste(year_reservation, month_reservation, day_reservation,sep="-")), "%Y-%m-%d")

reservation_per_day <- reservations %>%
  mutate(day_mon_rest=paste(day_reservation,month_reservation,ID))%>%
  group_by(ID,day_mon_rest,date) %>%
  summarise(Tot_visit_day_from_Reservations = sum(reserve_visitors),
            count_of_reservations = n()) 

head(reservation_per_day)
```
Now we've created a summarized version of the reservation dataset and we need to join this into the visits dataset to form our total dataset with all of the variables we will use

```{r}
visits <- visits %>% add_row(ID="restaurant_ 292",air_genre_name="Cafe/Sweets",air_area_name="T?ky?-to Shibuya-ku Shibuya",latitude=35.66178,longitude=139.7041) %>% add_row(ID="restaurant_ 325",air_genre_name="Cafe/Sweets",air_area_name="Hokkaid? Sapporo-shi Minami 3 J?nishi",latitude=43.05546,longitude=141.341)

date_info$calendar_date=ymd(date_info$calendar_date)

combinedDataset <- visits %>% mutate(date = visit_date) %>%  left_join(reservation_per_day,by = c('date','ID')) %>%
  mutate(calendar_date=date) %>% left_join(date_info,by='calendar_date')

combinedDataset %>% group_by(air_genre_name) %>% summarise(avgDailyVisitsGenre = mean(visitors))

combinedDataset <- combinedDataset %>% left_join(
  y=(combinedDataset %>% group_by(air_genre_name) %>% summarise(avgDailyVisitsGenre = mean(visitors))),
by="air_genre_name")


```

Create Training and test
```{r}
trainset <- subset(combinedDataset,visit_date <= as.Date("2017-03-10"))
testset <- subset(combinedDataset,visit_date > as.Date("2017-03-10"))
```



## Now we wwill begin to fit with linear regression models to start
This is a simpler modeling technique and we want to start here to see if by chance it is the best fitting type of model. 

### Model 1
```{r}

mod1<-lm(visitors ~ date + air_genre_name+latitude+longitude+count_of_reservations, data=trainset)

summary(mod1)
```



### Model 2

```{r}


mod2<- lm( visitors ~ date + Tot_visit_day_from_Reservations + day_of_week + holiday_flg + air_genre_name + latitude + longitude, data=trainset)

summary(mod2)
```

### Model 3
```{r}
mod3<- lm( visitors ~ visit_date + Tot_visit_day_from_Reservations + day_of_week + holiday_flg + air_genre_name + air_area_name, data=trainset)
summary(mod3)
```

### Model 4

```{r}
mod4<- lm( visitors ~  ID + visit_date + Tot_visit_day_from_Reservations + day_of_week + holiday_flg + air_genre_name + latitude + longitude, data=trainset)
summary(mod4)

```

### Model 5 

```{r}
mod5<- lm( visitors ~  ID + day_of_week + holiday_flg + air_genre_name + air_area_name, data=trainset)
summary(mod5)

```

### Model 6

```{r}
mod6<- lm( visitors ~  visit_date + day_of_week + holiday_flg + air_genre_name + air_area_name, data=trainset)
summary(mod6)
```



# validation of the model

```{r}
predictTest<-predict(mod5, newdata = (testset%>%filter(ID!="restaurant_ 514"&ID!="restaurant_ 516"&ID!="restaurant_ 573")%>%arrange(ID)))

#Calculation of SSE

testset=testset %>%arrange(ID)

testset$visitors%>%length()

predictTest%>%length()


sse<-sum((testset$visitors-predictTest)^2)

#Calculation of the average of Tot visi per day in the Test set

ybar<- mean(testset$visitors)

#Calculation of SST

sst<-sum((testset$visitors-ybar)^2)

#Calculation of R-squared

rsquared<- (1-(sse/sst))

rsquared

############### Method from below may work here but something needs to be fixed with the datasets

names(testset)
testset<-testset%>%filter(ID!="restaurant_ 514",ID!="restaurant_ 516",ID!="restaurant_ 573")
predictTest1<-predict(mod5, newdata = testset)

#Calculation of SSE

sse<-sum((testset$visitors-predictTest1)^2)

#Calculation of the average of Tot visi per day in the Test set

ybar2<- mean(testset$visitors)

#Calculation of SST

sst<-sum((testset$visitors-ybar2)^2)

#Calculation of R-squared

rsquared2<- (1-(sse/sst))

rsquared2



```

##################NEEED TO FIX - TEST SET AND PREDICTION NOT THE SAME IN THIS CASE

## Refitting LM model with full dataset

Now that we've tested with a train test split we want to reload the best LM model with the full dataset so that we don't drop levels when we predict the submission dataset.

```{r}
mod5<- lm( visitors ~  ID + day_of_week + holiday_flg + air_genre_name + air_area_name, data=combinedDataset)
summary(mod5)
```


```{r}
submission <- read.csv("project_submission (1).csv")
```

```{r}
submission<-submission%>%mutate(date1 = str_sub(ID,-10,-1))
submission<-submission%>%mutate(id = str_sub(ID,1,-13))
submission$date1<-ymd(submission$date1)
head(submission)
submission[1,4]
submission$id <- str_trim(submission$id)
submission[1,4]

submission<-rename(submission,id=ID,date=date1,ID=id)

submission$counter <- seq(from=1,to=15770,by=1) 

submission <- submission %>% left_join(restaurant_info, by="ID") %>% left_join(date_info %>% mutate(date = ymd(calendar_date)),by="date")

submission %>% pull(ID) %>% unique() %>%length() 
restaurant_info %>% pull(ID) %>% unique() %>%length() 

combinedDataset %>% filter(ID == "restaurant_ 292")

visits %>% filter(ID == "restaurant_ 292")

restaurant_info %>% filter(ID == "restaurant_ 292")

submission_zeroes <- submission %>% filter(ID=="restaurant_ 292"|ID=="restaurant_ 325")

submission <- submission %>% filter(ID!="restaurant_ 292"&ID!="restaurant_ 325")


submission$visitors <- predict(mod5, newdata = submission)
submission$visitors <- round(submission$visitors,0)
submission_zeroes <- submission_zeroes %>% select(id,visitors,counter)
submission <- submission %>% select(id,visitors,counter)
submission <-rename(submission,ID=id)
names(submission_zeroes)
submission_zeroes <-rename(submission_zeroes,ID=id)
# submission <- submission %>% add_row(ID="restaurant_ 292",visitors=0) %>% add_row(ID="restaurant_ 325",visitors=0)

glimpse(submission)

submission <- bind_rows(submission,submission_zeroes) %>%arrange(counter)%>%select(-counter)

skimr::skim(submission)

submission %>% filter(str_detect(ID,"restaurant_ 292")|str_detect(ID,"restaurant_ 325"))

submission %>% janitor::tabyl(visitors)

submission$visitors <- if_else(submission$visitors<0,0,submission$visitors)

submission %>% janitor::tabyl(visitors)

submission %>% write_csv("project6_data_submission.csv")

```



## Now let's explore decision tree fits

Now we specify and then fit the models.


```{r}
library(tidymodels)

set.seed(42)

combinedDataset=combinedDataset%>%select(-X.y)

data_split <- initial_time_split(combinedDataset, prop = 0.75)

tm_train <- training(data_split) 
tm_test <- testing(data_split)

tm_rec <- tm_train %>%
  recipe(visitors ~ . ) %>%
  step_normalize(all_predictors())

# Show the result of our recipe
tm_rec 

```
To combine the data preparation with the model building, we use the **workflows**.



```{r}
rf_spec <- rand_forest(mode = "regression") %>%
  set_engine("ranger")

rf_spec
## Random Forest Model Specification (regression)
##
## Computational engine: ranger
rf_fit <- rf_spec %>%
  fit(visitors ~ .,
    data = tm_train
  )

rf_fit

# results_train <- rf_fit %>%
#     predict(new_data = tm_train) %>%
#     mutate(
#       truth = tm_train$visitors,
#       model = "rf"
#     )
# 
# results_test <- rf_fit %>%
#     predict(new_data = tm_test) %>%
#     mutate(
#       truth = tm_test$visitors,
#       model = "rf"
#     )



```





```{r}
# results_train <- lm_fit %>%
#   predict(new_data = nfl_train) %>%
#   mutate(
#     truth = nfl_train$weekly_attendance,
#     model = "rf"
#   )

```

##########

# Creation of the regression tree with training set

```{r}
library(rpart)
library(rpart.plot)
library(caTools)

split <- sample.split(combinedDataset$visitors, SplitRatio = 0.85)
Train<- subset(combinedDataset, split == TRUE)
Test<- subset(combinedDataset, split == FALSE)


# firsttree <- rpart(
#   formula = visitors ~ ID+visit_date+air_area_name+latitude+longitude+air_genre_name+avgDailyVisitsGenre+date+count_of_reservations,
#   data    = Train,
#   method  = "anova"
#   )
# firsttree

```

#Validation with the test set

```{r}

# Test2<- Test%>%filter(ID!="restaurant_ 292"&ID!="restaurant_ 325")%>%arrange(ID)
# predtree <- predict(firsttree, newdata=Test2)
# ## Test set filtered above
# 
# #Calculation of SSE
# 
# Test2=Test2 %>%arrange(ID)
# 
# Test2$visitors%>%length()
# 
# predtree%>%length()
# 
# 
# sse<-sum((Test2$visitors-predtree)^2)
# 
# #Calculation of the average of Tot visi per day in the Test set
# 
# ybar<- mean(Test2$visitors)
# 
# #Calculation of SST
# 
# sst<-sum((Test2$visitors-ybar)^2)
# 
# #Calculation of R-squared
# 
# rsquared<- (1-(sse/sst))
# 
# rsquared


```

###### Trying a new model

Considering visti date time instead of reserve date time to not lose information relate to the future

```{r}
submission2 <- read.csv("project_submission (1).csv")
```

```{r}
submission2<-submission2%>%mutate(date1 = str_sub(ID,-10,-1))
submission2<-submission2%>%mutate(id = str_sub(ID,1,-13))
submission2$date1<-ymd(submission2$date1)
head(submission2)
submission2[1,4]
submission2$id <- str_trim(submission2$id)
submission2[1,4]

submission2<-rename(submission2,id=ID,date=date1,ID=id)

submission2$counter <- seq(from=1,to=15770,by=1) 

submission2 <- submission2 %>% left_join(restaurant_info, by="ID") %>% left_join(date_info %>% mutate(date = ymd(calendar_date)),by="date")

submission %>% pull(ID) %>% unique() %>%length() 
restaurant_info %>% pull(ID) %>% unique() %>%length()

reservations<- reservations%>%mutate(day_reservation = day(reservations$visit_datetime))
reservations<- reservations%>%mutate(month_reservation = month(reservations$visit_datetime))
reservations<- reservations%>%mutate(year_reservation = 2017)
reservations<- reservations%>%mutate(date = '')

reservations$date <- as.Date(with(reservations, paste(year_reservation, month_reservation, day_reservation,sep="-")), "%Y-%m-%d")

reservation_per_day <- reservations %>%
  mutate(day_mon_rest=paste(day_reservation,month_reservation,ID))%>%
  group_by(ID,day_mon_rest,date) %>%
  summarise(Tot_visit_day_from_Reservations = sum(reserve_visitors),
            count_of_reservations = n())

combinedDataset$count_of_reservations[is.na(combinedDataset$count_of_reservations)] <- 0
combinedDataset$Tot_visit_day_from_Reservations[is.na(combinedDataset$Tot_visit_day_from_Reservations)] <- 0

mod5up<- lm( visitors ~  ID + day_of_week + holiday_flg + air_genre_name + air_area_name+count_of_reservations+Tot_visit_day_from_Reservations, data=combinedDataset)
summary(mod5up)

# skimr::skim(submission2)

submission2 <- submission2 %>% select(-date)%>%mutate(date=calendar_date) %>% select(-calendar_date) %>% left_join(reservation_per_day,by=c("ID", "date"))

submission2$count_of_reservations[is.na(submission2$count_of_reservations)] <- 0
submission2$Tot_visit_day_from_Reservations[is.na(submission2$Tot_visit_day_from_Reservations)] <- 0

# skimr::skim(submission2)
# skimr::skim(combinedDataset)
# 
# tail(combinedDataset)
# submission2%>%filter(ID=="restaurant_ 292")

combinedDataset %>% filter(ID=="restaurant_ 104")

submission_zeroes2 <- submission2 %>% filter(ID=="restaurant_ 292"|ID=="restaurant_ 325")

submission2 <- submission2 %>% filter(ID!="restaurant_ 292"&ID!="restaurant_ 325")


submission2$visitors <- predict(mod5up, newdata = submission2)
submission2$visitors <- round(submission2$visitors,0)
submission_zeroes2 <- submission_zeroes %>% select(ID,visitors,counter)
submission2 <- submission2 %>% select(ID,visitors,counter)
# submission2 <-rename(submission2,ID=id)
names(submission_zeroes2)
# submission_zeroes2 <-rename(submission_zeroes2,ID=id)
# submission <- submission %>% add_row(ID="restaurant_ 292",visitors=0) %>% add_row(ID="restaurant_ 325",visitors=0)

glimpse(submission2)

submission2 <- bind_rows(submission2,submission_zeroes2) %>%arrange(counter)%>%select(-counter)

skimr::skim(submission)

submission2 %>% filter(str_detect(ID,"restaurant_ 292")|str_detect(ID,"restaurant_ 325"))

submission2 %>% janitor::tabyl(visitors)

submission2$visitors <- if_else(submission2$visitors<0,0,submission2$visitors)

submission2 %>% janitor::tabyl(visitors)

submission2 %>% write_csv("project6_data_submission2.csv")
```



